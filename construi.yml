image: docker:17.07.0-ce

default: build

environment:
  - DOCKER_PUSH_NAME=lstephen/versiune
  - DOCKER_PUSH_EMAIL=levi.stephen@gmail.com
  - DOCKER_PUSH_USERNAME
  - DOCKER_PUSH_PASSWORD

volumes:
  - /var/run/docker.sock:/var/run/docker.sock

targets:
  versiune:
    build: .
    run: VERSION

  build:
    before:
      - versiune
    run:
      - /bin/sh -c "docker build -t $DOCKER_PUSH_NAME:$(cat VERSION) ."

  release:
    before:
      - versiune
    volumes:
      - $GIT_SSH_KEY:/ssh/id_rsa
    run:
      - /bin/sh -c "docker login -u '$DOCKER_PUSH_USERNAME' -p '$DOCKER_PUSH_PASSWORD' -e 'DOCKER_PUSH_EMAIL'"
      - /bin/sh -c "docker tag -f $DOCKER_PUSH_NAME:$(cat VERSION) $DOCKER_PUSH_NAME:latest"
      - /bin/sh -c "docker push $DOCKER_PUSH_NAME:$(cat VERSION)"
      - /bin/sh -c "docker push $DOCKER_PUSH_NAME:latest"

